<!DOCTYPE html>
<html lang="en">
  <head>
    <title>logucene</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <!-- <link href="https://cdn.jsdelivr.net/npm/primeicons@7.0.0/primeicons.css" rel="stylesheet"> -->
    <link href="/webjars/primeicons/7.0.0/primeicons.css" rel="stylesheet">
    <style>
      body {
        margin: 0;
      }
      #app {
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .p-tabpanels,.p-tabpanel-active {
        height: 100%;
      }
      .p-datatable,.p-datatable-table,.p-datatable-tbody {
        height: 100%;
      }
      .p-datatable-table-container {
        height: calc(100% - 58px);
      }
      .p-datatable-tbody > tr > td {
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      }
    </style>
  </head>
  <body>
    <!-- <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.js"></script> -->
    <script src="/webjars/axios/1.11.0/dist/axios.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/echarts@6.0.0/dist/echarts.js"></script> -->
    <script src="/webjars/echarts/6.0.0/dist/echarts.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue@3.5.18/dist/vue.global.js"></script> -->
    <script src="/webjars/vue/3.5.18/dist/vue.global.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/primevue@4.3.7/umd/primevue.min.js"></script> -->
    <script src="/webjars/primevue/4.3.3/umd/primevue.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/@primevue/themes@4.3.3/umd/nora.min.js"></script> -->
    <script src="/webjars/primevue__themes/4.3.3/umd/nora.min.js"></script>

    <div id="app">
    </div>

    <script>
      const { createApp, ref, h } = Vue;
      const {
        Button,
        Column,
        Config,
        DataTable,
        DatePicker,
        Dialog,
        FileUpload,
        InputText,
        IftaLabel,
        MultiSelect,
        PickList,
        Select,
        Splitter,
        SplitterPanel,
        Tab,
        Tabs,
        TabList,
        TabPanel,
        TabPanels,
        Themes,
        Toast,
        ToastService,
        ToggleSwitch,
        Tooltip,
        Tree,
        useToast, 
      } = PrimeVue;

      const root = {
        template: `
          <Toast position="bottom-right" />
          <div style="display: flex; justify-content: space-between;">
            <div style="display: flex; align-items: center; width: 80px; justify-content: space-evenly;">
              <i class="pi pi-bolt" :style="{'font-size': '1.5rem', 'color': realtime.enable ? '#10b981' : '#cbd5e1'}"></i>
              <ToggleSwitch v-tooltip.bottom="'RealTime'" v-model="realtime.enable" @change="switchRealTimeMode" />
            </div>
            <div style="display: flex; width: calc(100% - 100px);">
              <IftaLabel>
                <DatePicker v-model="condition.day.from" :minDate="config.day.min" :maxDate="config.day.max" inputId="day-from" :disabled="realtime.enable" showIcon showButtonBar @update:modelValue="changeSearchCondition" :inputStyle="{'width': '110px'}" />
                <label for="day-from">Day(From)</label>
              </IftaLabel>
              <IftaLabel>
                <DatePicker v-model="condition.day.to" :minDate="config.day.min" :maxDate="config.day.max" inputId="day-to" :disabled="realtime.enable" showIcon showButtonBar @update:modelValue="changeSearchCondition" :inputStyle="{'width': '110px'}" />
                <label for="day-to">Day(To)</label>
              </IftaLabel>
              <IftaLabel>
                <MultiSelect v-model="condition.host" inputId="host" :disabled="realtime.enable" :options="config.host" style="width: 150px;" filter :maxSelectedLabels="1" @update:modelValue="changeSearchCondition" />
                <label for="host">Host</label>
              </IftaLabel>
              <IftaLabel>
                <MultiSelect v-model="condition.facility" inputId="facility" :disabled="realtime.enable" :options="config.facility" style="width: 150px;" filter :maxSelectedLabels="1" @update:modelValue="changeSearchCondition" />
                <label for="facility">Facility</label>
              </IftaLabel>
              <IftaLabel>
                <MultiSelect v-model="condition.severity" inputId="severity" :disabled="realtime.enable" :options="config.severity" style="width: 150px;" filter :maxSelectedLabels="1" @update:modelValue="changeSearchCondition" />
                <label for="severity">Severity</label>
              </IftaLabel>
              <IftaLabel style="width: calc(100% - 950px);">
                <InputText type="text" v-model="condition.query" id="query" :disabled="realtime.enable" style="width: 100%;" @keydown="$event.key == 'Enter' && changeSearchCondition()" />
                <label for="query">Query</label>
              </IftaLabel>
              <Button v-tooltip.bottom="'Search'" severity="success" icon="pi pi-search" :disabled="realtime.enable" @click="changeSearchCondition" />
              <Button v-tooltip.bottom="'Download'" severity="info" icon="pi pi-download" :disabled="realtime.enable" @click="showDownloadDialog" />
              <Button v-tooltip.bottom="'Upload'" severity="danger" icon="pi pi-upload" :disabled="realtime.enable" @click="showUploadDialog" />
              <Button v-tooltip.bottom="'Clear Filter'" severity="warn" icon="pi pi-filter-slash" :disabled="realtime.enable" @click="clearFilter" />
              <Button severity="help" icon="pi pi-cog" @click="showConfigDialog" />
            </div>
          </div>
          <Splitter style="height: calc(100% - 58px);" @resize="onResize">
            <!-- TODO: Tree/Summary/Timelineをこちらに表示 -->
            <SplitterPanel :size="20" :minSize="10">
              <Tree
                :value="tree.value"
                :loading="realtime.enable"
                v-model:selectionKeys="tree.selectedKeys"
                selectionMode="single"
                style="height: 100%; overflow: auto;"
                @nodeSelect="treeSelect"
                @nodeUnselect="treeUnselect"
                @nodeExpand="treeExpand"
              >
                <template #default="slotProps">
                  <label>{{ slotProps.node.label }}({{ slotProps.node.data.count.toLocaleString() }})</label>
                  <div><progress :max="slotProps.node.data.subtotal" :value="slotProps.node.data.count"></progress></div>
                </template>
              </Tree>
            </SplitterPanel>
            <SplitterPanel :size="80">
              <Tabs :value="tab" @update:value="tabSwitch" style="height: 100%; padding: 10px 10px 0 10px;">
                <TabList>
                  <Tab value="table">Table</Tab>
                  <Tab value="summary">Summary</Tab>
                  <Tab value="timeline" :disabled="realtime.enable">Timeline</Tab>
                </TabList>
                <TabPanels>
                  <TabPanel value="table">
                    <DataTable
                      ref="table"
                      showGridlines
                      scrollable
                      paginator
                      :lazy="true"
                      :totalRecords="table.total"
                      :first="table.first"
                      :rows="table.rows"
                      :rowsPerPageOptions="[1000, 3000, 5000, 10000]"
                      :value="table.logs"
                      scrollHeight="100%"
                      :virtualScrollerOptions="{ itemSize: 37 }"
                      selectionMode="single"
                      v-model:selection="table.selected"
                      @page="pageChange"
                      style="padding: 10px;"
                      size="small"
                      v-if="table.show"
                      resizableColumns
                      columnResizeMode="expand"
                    >
                      <Column
                        v-for="field in table.fields[0]"
                        :field="field.field"
                        :header="field.header"
                        :headerStyle="{'background-color': 'lightgray'}"
                      >
                      </Column>
                      <template #empty> no data. </template>
                    </DataTable>
                  </TabPanel>
                  <TabPanel value="summary">
                    <div style="display: flex;">
                      <IftaLabel style="width: 50%;">
                        <Select style="width: 100%;" v-model="summary.yaxis" inputId="summary-yaxis" :options="Object.keys(axis)" @change="changeSummaryAxis" />
                        <label for="summary-yaxis">Y-Axis</label>
                      </IftaLabel>
                      <IftaLabel style="width: 50%;">
                        <Select style="width: 100%;" v-model="summary.xaxis" inputId="summary-xaxis" :options="Object.keys(axis)" @change="changeSummaryAxis" />
                        <label for="summary-xaxis">X-Axis</label>
                      </IftaLabel>
                    </div>
                    <div ref="summary" style="height: calc(100% - 58px);"></div>
                  </TabPanel>
                  <TabPanel value="timeline">
                    <div style="display: flex;">
                      <IftaLabel style="width: 50%;">
                        <Select style="width: 100%;" v-model="timeline.yaxis" inputId="timeline-yaxis" :options="timeline.span" optionLabel="name" @change="changeTimelineAxis" />
                        <label for="timeline-yaxis">Y-Axis</label>
                      </IftaLabel>
                      <IftaLabel style="width: 50%;">
                        <Select style="width: 100%;" v-model="timeline.xaxis" inputId="timeline-xaxis" @change="changeTimelineAxis" />
                        <label for="timeline-xaxis">X-Axis</label>
                      </IftaLabel>
                    </div>
                    <div ref="timeline" style="height: calc(100% - 58px);"></div>
                  </TabPanel>
                </TabPanels>
              </Tabs>
            </SplitterPanel>
          </Splitter>
          <Dialog v-model:visible="dialog.config.show" modal :dismissableMask="true" header="Config">
            <div style="display: flex; width: 1000px; justify-content: space-around;">
              <div>
                <h3>Tree</h3>
                <PickList v-model="tree.drilldown" @update:modelValue="changeDrilldown">
                  <template v-slot:sourceheader>
                    <label style="font-weight: bold;">Enable</label>
                  </template>
                  <template v-slot:targetheader>
                    <label style="font-weight: bold;">Disable</label>
                  </template>
                  <template #option="{ option }">
                    <label style="width: 100px;">{{ option }}</label>
                  </template>
                </PickList>
              </div>
              <div>
                <h3>Table</h3>
                <PickList v-model="table.fields" dataKey="field">
                  <template v-slot:sourceheader>
                    <label style="font-weight: bold;">Show</label>
                  </template>
                  <template v-slot:targetheader>
                    <label style="font-weight: bold;">Hidden</label>
                  </template>
                  <template #option="{ option }">
                    <label style="width: 100px;">{{ option.header }}</label>
                  </template>
                </PickList>
              </div>
            </div>
          </Dialog>
          <Dialog v-model:visible="dialog.download.show" modal :dismissableMask="true" header="Download">
            <DataTable :value="Object.values(jobs.list).filter(job => job.type == 'export').sort((a, b) => a.start < b.start ? -1 : a.start > b.start ? 1 : 0)">
              <Column field="start" header="Start" style="width: 180px;"></Column>
              <Column field="finish" header="Finish" style="width: 180px;"></Column>
              <Column field="format" header="Format" style="width: 80px;"></Column>
              <Column header="Progress" style="width: 200px;">
                <template #body="slotProps">
                  <progress :max="slotProps.data.progress.max" :value="slotProps.data.progress.current"></progress>
                </template>
              </Column>
              <Column header="Detail" style="width: 180px;">
                <template #body="slotProps">
                  {{ slotProps.data.error ? slotProps.data.error : '' }}
                </template>
              </Column>
              <Column header="Operation" style="width: 270px;">
                <template #body="slotProps">
                  <div style="display: flex; gap: 0.5rem;">
                    <Button label="Download" icon="pi pi-download" severity="info" :disabled="!slotProps.data.finish || slotProps.data.error" @click="download(slotProps.data.id)" />
                    <Button label="Remove" icon="pi pi-trash" severity="danger" :disabled="!slotProps.data.finish" @click="removeJob(slotProps.data.id)" />
                  </div>
                </template>
              </Column>
              <template #empty> no data. </template>
            </DataTable>
            <template #footer>
              <Button label="SQLite" icon="pi pi-database" @click="startExportJob('sqlite')" severity="secondary" />
              <Button label="TSV" icon="pi pi-file" @click="startExportJob('tsv')" severity="secondary" />
            </template>
          </Dialog>
          <Dialog v-model:visible="dialog.upload.show" modal :dismissableMask="true" header="Upload">
            <DataTable :value="Object.values(jobs.list).filter(job => job.type == 'import').sort((a, b) => a.start < b.start ? -1 : a.start > b.start ? 1 : 0)">
              <Column field="start" header="Start" style="width: 180px;"></Column>
              <Column field="finish" header="Finish" style="width: 180px;"></Column>
              <Column field="format" header="Format" style="width: 80px;"></Column>
              <Column header="Progress" style="width: 200px;">
                <template #body="slotProps">
                  <progress :max="slotProps.data.progress.max" :value="slotProps.data.progress.current"></progress>
                </template>
              </Column>
              <Column header="Detail" style="width: 180px;">
                <template #body="slotProps">
                  {{ slotProps.data.error ? slotProps.data.error : '' }}
                </template>
              </Column>
              <Column header="Operation" style="width: 270px;">
                <template #body="slotProps">
                  <div style="display: flex; gap: 0.5rem;">
                    <Button label="Download" icon="pi pi-download" severity="info" :disabled="!slotProps.data.finish || slotProps.data.error" @click="download(slotProps.data.id)" />
                    <Button label="Remove" icon="pi pi-trash" severity="danger" :disabled="!slotProps.data.finish" @click="removeJob(slotProps.data.id)" />
                  </div>
                </template>
              </Column>
              <template #empty> no data. </template>
            </DataTable>
            <template #footer>
              <FileUpload ref="uploadfile" mode="basic" name="tsv" :multiple="true" url="/api/import/tsv" @before-upload="blocked = true" @upload="blocked = false" @error="blocked = false" />
              <Button label="Upload" @click="upload" severity="secondary" />
            </template>
          </Dialog>
          <div v-if="blocked" style="position: fixed; top: 0px; left: 0px; width: 100%; height: 100%; z-index: 9999; background-color: rgba(0, 0, 0, 0.4);"></div>
        `,
        data: function() {
          return {
            http: axios.create(),
            blocked: false,
            toast: useToast(),
            dialog: {
              config: {show: false},
              download: {show: false},
              upload: {show: false},
            },
            jobs: {
              list: {},
              socket: null
            },
            realtime: {
              socket: null,
              enable: false,
            },
            tab: 'table',
            config: {
              day: {min: new Date(), max: new Date()},
              host: [],
              facility: [],
              severity: [],
            },
            condition: {
              day: {from: null, to: null},
              host: [],
              facility: [],
              severity: [],
              // TODO: multiple
              query: '*:*',
            },
            table: {
              fields: [[
                {field: 'datetime', header: 'timestamp'},
                {field: 'host', header: 'host'},
                {field: 'facility', header: 'facility'},
                {field: 'severity', header: 'severity'},
                {field: 'message', header: 'message'},
              ], [
                // {field: 'id', header: 'id'},
                {field: 'sort', header: 'sort'},
                {field: 'format', header: 'format'},
                {field: 'addr', header: 'addr'},
                {field: 'port', header: 'port'},
                {field: 'raw', header: 'raw'},
              ]],
              logs: [],
              total: 0,
              first: 0,
              rows: 1000,
              selected: null,
              show: true
            },
            axis: {
              'host': {
                query: value => `host:"${value}"`,
                format: log => log.host,
                collect: data => [...new Set(data)].sort()
              },
              'format': {
                query: value => `format:"${value}"`,
                format: log => log.format,
                collect: data => ['unknown', 'rfc3164', 'rfc5424']
              },
              'addr': {
                query: value => `addr:"${value}"`,
                format: log => log.addr,
                collect: data => [...new Set(data)].sort()
              },
              'facility': {
                query: value => `facility:"${value}"`,
                format: log => log.facility,
                collect: data => [...new Set(data)].sort()
              },
              'severity': {
                query: value => `severity:"${value}"`,
                format: log => log.severity,
                collect: data => this.$data.config.severity
              },
            },
            summary: {
              instance: null,
              yaxis: 'host',
              xaxis: 'severity',
            },
            timeline: {
              instance: null,
              yaxis: {name: '1 day', value: 60 * 24},
              xaxis: 'severity',
              span: [
                {name: '10 minutes', value: 10},
                {name: '1 hour', value: 60},
                {name: '1 day', value: 60 * 24},
              ],
            },
            tree: {
              value: [],
              selectedKeys: [],
              selected: null,
              drilldown: [[
                'severity',
                'host',
              ],[
                'format',
                'addr',
                'facility',
              ]],
            }
          };
        },
        mounted: function() {
          document.cookie = Object.entries({
            'X-Tz-Offset': new Date().getTimezoneOffset(),
          }).map(
            ([key, value]) => `${key}=${value};`
          ).reduce(
            (acc, x) => `${acc} ${x}`
          );

          window.addEventListener('resize', this.onResize);

          var count = 0;
          var unblock = () => {
            return new Promise((resolve, reject) => {
              count--;
              if (count <= 0) {
                count = 0;
                this.$data.blocked = false;
              }
              this.$nextTick(() => resolve());
            });
          };

          this.$data.http.interceptors.request.use((config) => {
            return new Promise((resolve, reject) => {
              count++;
              this.$data.blocked = true;
              this.$nextTick(() => resolve(config));
            });
          }, (error) => {
            return unblock().then(() => Promise.reject(error));
          });

          this.$data.http.interceptors.response.use((response) => {
            return unblock().then(() => response);
          }, (error) => {
            return unblock().then(
              () => Promise.reject(error)
            ).then(() => {
              console.error(error);
              this.$data.toast.add({
                severity: 'error',
                summary: error,
              });
              return Promise.reject(error);
            });
          });

          var newWebSocket = () => {
            this.$data.jobs.socket = new WebSocket("/ws/job");
            this.$data.jobs.socket.addEventListener("close", event => {
              setTimeout(() => newWebSocket(), 1000);
            });
            this.$data.jobs.socket.addEventListener("message", event => {
              var message = JSON.parse(event.data);
              if (message.event == 'remove') {
                this.$data.jobs.list = Object.values(
                  this.$data.jobs.list
                ).filter(
                  job => job.id != message.id
                ).reduce(
                  (jobs, job) => {
                    jobs[job.id] = job;
                    return jobs;
                  }, {}
                );
              } else {
                this.$data.jobs.list[message.id] = message;
                if (message.finish) {
                  if (message.error) {
                    this.$data.toast.add({
                      severity: 'error',
                      summary: `${message.type} job failed.`,
                      detail: message.error
                    });
                  } else {
                    this.$data.toast.add({
                      severity: 'info',
                      summary: `${message.type} job finished.`,
                      life: 5000,
                    });
                  }
                }
              }
            });
          };
          newWebSocket();

          var config = PrimeVue.usePrimeVue().config;
          console.debug(config);

          this.$data.http.get(
            '/api/config'
          ).then(response => {
            this.$data.config.host        = response.data.host;
            this.$data.config.facility    = response.data.facility;
            this.$data.config.severity    = response.data.severity;
            this.$data.config.day.min     = new Date(response.data.day.min);
            this.$data.config.day.max     = new Date(response.data.day.max);
            config.locale.dateFormat      = 'yy-mm-dd';
            config.locale.dayNames        = response.data.dayNames;
            config.locale.dayNamesMin     = response.data.dayNamesMin;
            config.locale.dayNamesShort   = response.data.dayNamesShort;
            config.locale.monthNames      = response.data.monthNames;
            config.locale.monthNamesShort = response.data.monthNamesShort;
            console.debug(config);
          }).then(
            () => this.search()
          ).catch(e => {
            this.$data.toast.add({
              severity: 'error',
              summary: e,
            });
          });
        },
        methods: {
          onResize: function() {
            switch (this.$data.tab) {
              case 'table':
                this.$data.table.show = false;
                this.$nextTick(() => {
                  this.$data.table.show = true;
                });
                break;
              case 'summary':
                this.$data.summary.instance?.resize();
                break;
              case 'timeline':
                this.$data.timeline.instance?.resize();
                break;
            }
          },
          showConfigDialog: function() {
            this.$data.dialog.config.show = true;
          },
          showDownloadDialog: function() {
            this.$data.http.get(
              '/api/job'
            ).then(
              response => this.$data.jobs.list = response.data
            ).then(
              () => this.$data.dialog.download.show = true
            );
          },
          showUploadDialog: function() {
            this.$data.http.get(
              '/api/job'
            ).then(
              response => this.$data.jobs.list = response.data
            ).then(
              () => this.$data.dialog.upload.show = true
            );
          },
          treeSelect: function(node) {
            this.$data.tree.selected = node;
            this.tabSwitch();
          },
          treeUnselect: function(node) {
            this.$data.tree.selected = null;
            this.tabSwitch();
          },
          treeExpand: function(node) {
            var axis = [...node.data.axis];
            var field = axis.shift();
            var query = encodeURIComponent(this.getQuery(node));
            this.groupCount(query, field).then(response => {
              var count = response.data;
              var total = Object.values(response.data).reduce((acc, x) => acc + x);
              node.children = Object.keys(count).sort(
                (a, b) => count[b] - count[a]
              ).map((key, i) => {
                return {
                  key: `${node.key}-${i}`,
                  label: key,
                  data: {
                    'key': field,
                    'value': key,
                    'subtotal': total,
                    'count': count[key],
                    'axis': axis
                  },
                  leaf: axis.length == 0,
                  parent: node
                };
              });
            });
          },
          clearFilter: function() {
            this.$data.condition.day = {from: null, to: null};
            this.$data.condition.host = [];
            this.$data.condition.facility = [];
            this.$data.condition.severity = [];
            this.$data.condition.query = '*:*';
            this.$data.tree.selected = null;
            this.$data.tree.selectedKeys = [];
            this.search();
          },
          getQuery: function(node, query) {
            query = `(${query || this.$data.condition.query?.trim() || '*:*'})`;
            node = node || this.$data.tree.selected;
            var [from, to] = [this.$data.condition.day.from, this.$data.condition.day.to];
            if (from || to) {
              var format = (date, time) => {
                if (date) {
                  return `${date.getFullYear()}`
                    + `-${('0' + (date.getMonth() + 1)).slice(-2)}`
                    + `-${('0' + date.getDate()).slice(-2)}`
                    + ' ' + time;
                } else {
                  return "*";
                }
              };
              query = `${query} AND `
                + `timestamp:[`
                +   `"${format(from, '00:00:00.000')}"`
                +   ` TO `
                +   `"${format(to, '23:59:59.999')}"`
                + `]`;
            }
            if (this.$data.condition.host.length > 0) {
              query = `${query} AND (${this.$data.condition.host.map(x => `host:"${x}"`).join(' OR ')})`;
            }
            if (this.$data.condition.severity.length > 0) {
              query = `${query} AND (${this.$data.condition.severity.map(x => `severity:"${x}"`).join(' OR ')})`;
            }
            if (this.$data.condition.facility.length > 0) {
              query = `${query} AND (${this.$data.condition.facility.map(x => `facility:"${x}"`).join(' OR ')})`;
            }
            if (node) {
              if (node.data.key in this.$data.axis) {
                query = `${query} AND ${this.$data.axis[node.data.key].query(node.data.value)}`;
              } else {
                query = `${query} AND ${node.data.key}:"${node.data.value}"`;
              }
              if (node.parent) {
                query = this.getQuery(node.parent, query);
              }
            }
            return query;
          },
          changeSearchCondition: function() {
            this.tabSwitch();
          },
          search: function(event) {
            if (!this.$data.realtime.enable) {
              this.$data.table.logs = [];
              this.$data.table.total = 0;
              this.$data.table.first = 0;
              this.$data.tree.selected = null;
              this.$data.tree.selectedKeys = [];
              return Promise.resolve().then(
                () => this.pageChange({first: 0, rows: this.$data.table.rows}, true)
              ).then(() => {
                this.$data.tree.value = [{
                  key: 0,
                  label: 'ALL',
                  data: {
                    'key': '*',
                    'value': '*',
                    'subtotal': this.$data.table.total,
                    'count': this.$data.table.total,
                    'axis': [...this.$data.tree.drilldown[0]]
                  },
                  leaf: false
                }];
              });
            }
          },
          groupCount: function(query, field) {
            return this.$data.http.get(`/api/group/count?query=${query}&field=${field}`);
          },
          timelineCount: function(query) {
            return this.$data.http.get(`/api/group/count/timeline?query=${query}&span=${this.$data.timeline.yaxis.value}`);
          },
          pageChange: function(event, showToast) {
            this.$data.table.rows = event?.rows || this.$data.table.rows;
            this.$data.table.first = event?.first || 0;
            return this.$data.http.get(
              `/api/documents?query=${encodeURIComponent(this.getQuery())}`
              + `&first=${this.$data.table.first}`
              + `&last=${this.$data.table.first + this.$data.table.rows}`
            ).then(response => {
              this.$data.table.logs  = response.data.docs;
              this.$data.table.total = response.data.total;
              if (this.$data.table.total > 0) {
                if (showToast) {
                  this.$data.toast.add({
                    severity: 'info',
                    summary: `${this.$data.table.total.toLocaleString()} hits.(${response.data.ms.toLocaleString()}ms)`,
                    life: 5000,
                  });
                }
              } else {
                this.$data.toast.add({
                  severity: 'warn',
                  summary: `not found.`,
                  life: 5000,
                });
              }
            }).catch(e => {
              this.$data.toast.add({
                severity: 'error',
                summary: e,
              });
            });
          },
          startExportJob: function(format) {
            this.$data.http.post(`/api/export/${format}?query=${encodeURIComponent(this.getQuery())}`);
          },
          download: function(id) {
            var a = document.createElement('a');
            a.target = '_blank';
            a.href = `/api/download?id=${id}`;
            a.click();
          },
          removeJob: function(id) {
            this.$data.http.delete(`/api/job?id=${id}`);
          },
          upload: function() {
            this.$refs.uploadfile.upload();
          },
          switchRealTimeMode() {
            this.$data.tab = 'table';
            this.$data.table.logs = [];
            this.$data.table.total = 0;
            this.$data.summary.instance?.clear();
            this.$data.tree.selected = null;
            this.$data.tree.selectedKeys = [];
            this.$data.tree.value = [{
              key: null,
              label: '-',
              data: {
                'subtotal': 0,
                'count': 0
              },
              leaf: true
            }];
            if (this.$data.realtime.enable) {
              var newWebSocket = () => {
                this.$data.realtime.socket = new WebSocket("/ws/realtime");
                this.$data.realtime.socket.addEventListener("close", event => {
                  if (this.$data.realtime.enable) {
                    setTimeout(() => newWebSocket(), 1000);
                  }
                });
                this.$data.realtime.socket.addEventListener("message", event => {
                  this.$data.table.logs = [JSON.parse(event.data)].concat(this.$data.table.logs);
                  this.$data.tree.value[0].data.count++;
                  this.showSummary(true);
                });
              };
              newWebSocket();
            } else {
              this.$data.realtime.socket.close();
              this.$data.realtime.socket = null;
              this.search();
            }
          },
          tabSwitch: function(tab) {
            if (tab) {
              this.$data.tab = tab;
            }
            switch (this.$data.tab) {
              case 'table':
                this.search();
                break;
              case 'summary':
                this.showSummary();
                break;
              case 'timeline':
                this.showTimeline();
                break;
            }
          },
          changeSummaryAxis: function() {
            this.showSummary();
          },
          changeTimelineAxis: function() {
            this.showTimeline();
          },
          changeDrilldown: function() {
            if (!this.$data.realtime.enable) {
              this.$data.tree.selected = null;
              this.$data.tree.selectedKeys = [];
              this.search();
            }
          },
          showSummary: function(update) {
            if (this.$data.tab == 'summary') {
              if (!update) {
                this.$data.summary.instance?.dispose();
                this.$data.summary.instance = null;
              }
              var yaxis = this.$data.axis[this.$data.summary.yaxis];
              var xaxis = this.$data.axis[this.$data.summary.xaxis];
              var promise = (this.$data.realtime.enable
                ? Promise.resolve().then(() => {
                    var result = {
                      yaxis: yaxis.collect(this.$data.table.logs.map(row => row[this.$data.summary.yaxis])),
                      xaxis: xaxis.collect(this.$data.table.logs.map(row => row[this.$data.summary.xaxis])),
                      count: {}
                    };
                    for (var y of result.yaxis) {
                      result.count[y] = {};
                      for (var x of result.xaxis) {
                        result.count[y][x] = 0;
                      }
                    }
                    for (var log of this.$data.table.logs) {
                      result.count[yaxis.format(log)][xaxis.format(log)]++;
                    }
                    return result;
                  })
                : Promise.all([
                    this.groupCount(encodeURIComponent(this.getQuery()), this.$data.summary.yaxis),
                    this.groupCount(encodeURIComponent(this.getQuery()), this.$data.summary.xaxis),
                  ]).then(([y, x]) => {
                    var result = {
                      yaxis: yaxis.collect(Object.keys(y.data)),
                      xaxis: xaxis.collect(Object.keys(x.data)),
                      count: {}
                    };
                    for (var y of result.yaxis) {
                      result.count[y] = {};
                      for (var x of result.xaxis) {
                        result.count[y][x] = 0;
                      }
                    }
                    return new Promise((resolve, reject) => {
                      Promise.all(result.yaxis.map(y => {
                        return this.groupCount(
                          encodeURIComponent(this.getQuery() + ' AND ' + yaxis.query(y)),
                          this.$data.summary.xaxis
                        ).then(x => {
                          for (var [key, value] of Object.entries(x.data)) {
                            result.count[y][key] = value;
                          }
                        });
                      })).then(() => {
                        resolve(result);
                      });
                    });
                  })
              );
              return promise.then(response => {
                var summary = this.$data.summary.instance || echarts.init(this.$refs.summary);
                if (!this.$data.summary.instance) {
                  this.$data.summary.instance = summary;
                  summary.on('dblclick', (event) => {
                    if (!this.$data.realtime.enable) {
                      this.$data.condition.query = `(${this.$data.condition.query?.trim() || '*:*'}) `
                        + `AND ${yaxis.query(event.name)} `
                        + `AND ${xaxis.query(event.seriesName)}`;
                      this.search();
                      this.$data.tab = 'table';
                    }
                  });
                }
                var option = {
                  tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                      type: 'shadow'
                    }
                  },
                  legend: {},
                  xAxis: {
                    type: 'value'
                  },
                  yAxis: {
                    type: 'category',
                    data: response.yaxis
                  },
                  series: response.xaxis.map(x => {
                    return  {
                      name: x,
                      type: 'bar',
                      stack: 'total',
                      emphasis: {
                        focus: 'series'
                      },
                      data: response.yaxis.map(y => response.count[y][x])
                    };
                  })
                };
                summary.setOption(option);
              }).catch(e => {
                this.$data.toast.add({
                  severity: 'error',
                  summary: e,
                });
              });
            } else {
              return Promise.resolve();
            }
          },
          showTimeline: function(update) {
            if (this.$data.tab == 'timeline') {
              if (!update) {
                this.$data.timeline.instance?.dispose();
                this.$data.timeline.instance = null;
              }
              var query = encodeURIComponent(this.getQuery());
              this.timelineCount(
                query
              ).then(response => {
                var timeline = this.$data.timeline.instance || echarts.init(this.$refs.timeline);
                if (!this.$data.timeline.instance) {
                  this.$data.timeline.instance = timeline;
                  timeline.on('dblclick', (event) => {
                    console.log(event);
                    if (!this.$data.realtime.enable) {
                      this.$data.condition.query = `(${this.$data.condition.query?.trim() || '*:*'}) `
                        + `AND timestamp:["${event.data.min}" TO "${event.data.max}"]`;
                      this.search();
                      this.$data.tab = 'table';
                    }
                  });
                }
                var xaxis = Object.keys(response.data).sort().reverse();
                var option = {
                  tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                      type: 'shadow'
                    }
                  },
                  legend: {},
                  xAxis: {
                    type: 'value'
                  },
                  yAxis: {
                    type: 'category',
                    data: xaxis
                  },
                  series: {
                    type: 'bar',
                    data: xaxis.map(key => {
                      return {
                        value: response.data[key].count,
                        min: response.data[key].min,
                        max: response.data[key].max,
                      };
                    })
                  },
                  dataZoom: [
                    {
                      type: 'inside',
                      yAxisIndex: 0,
                      start: 0,
                      end: 100,
                      zoomOnMouseWheel: 'ctrl',
                      moveOnMouseWheel: true
                    },
                    {
                      type: 'slider',
                      yAxisIndex: 0,
                      start: 0,
                      end: 100
                    }
                  ]
                };
                timeline.setOption(option);
              }).catch(e => {
                this.$data.toast.add({
                  severity: 'error',
                  timeline: e,
                });
              });
            } else {
              return Promise.resolve();
            }
          }
        }
      };

      const app = createApp(root);

      app.use(Config, {
        theme: {
          preset: Themes.Nora
        }
      }).use(
        ToastService
      ).directive(
        'tooltip', Tooltip
      );

      const components = [
        Button,
        Column,
        DataTable,
        DatePicker,
        Dialog,
        FileUpload,
        InputText,
        IftaLabel,
        MultiSelect,
        PickList,
        Select,
        Splitter,
        SplitterPanel,
        Tab,
        Tabs,
        TabList,
        TabPanel,
        TabPanels,
        Toast,
        ToggleSwitch,
        Tree,
      ];
      for (var component of components) {
        app.component(component.name, component);
      }

      const proxy = app.mount('#app');
    </script>
  </body>
</html>
