<!DOCTYPE html>
<html lang="en">
  <head>
    <title>logucene</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <!-- <link href="https://cdn.jsdelivr.net/npm/primeicons@7.0.0/primeicons.min.css" rel="stylesheet"> -->
    <link href="/webjars/primeicons/7.0.0/primeicons.css" rel="stylesheet">
    <style>
      body {
        margin: 0;
      }
      #app {
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .p-tabs {
        height: calc(100% - 58px);
      }
      .p-tabpanels,.p-tabpanel-active {
        height: 100%;
      }
      .p-datatable,.p-datatable-table,.p-datatable-tbody {
        height: 100%;
      }
      .p-datatable-table-container {
        height: calc(100% - 58px - 1px);
      }
      .p-datatable-tbody > tr > td {
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <!-- <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script> -->
    <script src="/webjars/axios/1.11.0/dist/axios.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/echarts@6.0.0/dist/echarts.min.js"></script> -->
    <script src="/webjars/echarts/6.0.0/dist/echarts.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue@3.5.18/dist/vue.global.min.js"></script> -->
    <script src="/webjars/vue/3.5.18/dist/vue.global.prod.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/primevue@4.3.7/umd/primevue.min.js"></script> -->
    <script src="/webjars/primevue/4.3.3/umd/primevue.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/@primevue/themes@4.3.3/umd/nora.min.js"></script> -->
    <script src="/webjars/primevue__themes/4.3.3/umd/nora.min.js"></script>

    <div id="app">
    </div>

    <script>
      const { createApp, ref, h } = Vue;
      const {
        Button,
        Column,
        Config,
        DataTable,
        DatePicker,
        Dialog,
        FloatLabel,
        InputText,
        IftaLabel,
        MultiSelect,
        PickList,
        Select,
        Splitter,
        SplitterPanel,
        Tab,
        Tabs,
        TabList,
        TabPanel,
        TabPanels,
        Themes,
        Toast,
        ToastService,
        ToggleSwitch,
        Tooltip,
        Tree,
        useToast, 
      } = PrimeVue;

      const root = {
        template: `
          <Toast position="bottom-right" />
          <div style="display: flex; justify-content: space-between;">
            <div style="display: flex; align-items: center; width: 80px; justify-content: space-evenly;">
              <i class="pi pi-bolt" :style="{'font-size': '1.5rem', 'color': realtime ? '#10b981' : '#cbd5e1'}"></i>
              <ToggleSwitch v-tooltip.bottom="'RealTime'" v-model="realtime" @change="switchRealTimeMode" />
            </div>
            <div style="display: flex; width: calc(100% - 100px);">
              <IftaLabel>
                <DatePicker ref="datePicker" v-model="date" inputId="day" :disabled="realtime" dateFormat="yy-mm-dd" showIcon @update:modelValue="dateSelect" :inputStyle="{'width': '110px'}" />
                <label for="day">Day</label>
              </IftaLabel>
              <IftaLabel>
                <MultiSelect v-model="host" inputId="host" :disabled="realtime" :options="config.host" style="width: 150px;" filter :maxSelectedLabels="1" @update:modelValue="search" />
                <label for="host">Host</label>
              </IftaLabel>
              <IftaLabel>
                <MultiSelect v-model="facility" inputId="facility" :disabled="realtime" :options="config.facility" style="width: 150px;" filter :maxSelectedLabels="1" @update:modelValue="search" />
                <label for="facility">Facility</label>
              </IftaLabel>
              <IftaLabel>
                <MultiSelect v-model="severity" inputId="severity" :disabled="realtime" :options="config.severity" style="width: 150px;" filter :maxSelectedLabels="1" @update:modelValue="search" />
                <label for="severity">Severity</label>
              </IftaLabel>
              <IftaLabel style="width: calc(100% - 760px);">
                <InputText type="text" v-model="query" inputId="query" :disabled="realtime" style="width: 100%;" @keydown="$event.key == 'Enter' && search()" />
                <label for="query">Query</label>
              </IftaLabel>
              <Button v-tooltip.bottom="'Search'" severity="success" icon="pi pi-search" :disabled="realtime" @click="search" />
              <Button v-tooltip.bottom="'Download'" severity="info" icon="pi pi-download" :disabled="realtime" @click="download" />
              <Button v-tooltip.bottom="'Clear Filter'" severity="warn" icon="pi pi-filter-slash" :disabled="realtime" @click="clearFilter" />
              <Button severity="help" icon="pi pi-cog" @click="showDialog = true" />
            </div>
          </div>
          <Tabs :value="tab" @update:value="tabSwitch" style="padding: 10px 10px 0 10px;">
            <TabList>
              <Tab value="table">Table</Tab>
              <Tab value="barchart">BarChart</Tab>
            </TabList>
            <TabPanels>
              <TabPanel value="table">
                <Splitter style="height: 100%;">
                  <SplitterPanel :size="15" :minSize="10">
                    <Tree
                      :value="tree.value"
                      v-model:selectionKeys="tree.selectedKeys"
                      selectionMode="single"
                      style="height: 100%;"
                      @nodeSelect="treeSelect"
                      @nodeUnselect="treeUnselect"
                      @nodeExpand="treeExpand"
                    >
                      <template #default="slotProps">
                        <label>{{ slotProps.node.label }}({{ slotProps.node.data.count.toLocaleString() }})</label>
                        <div><progress :max="slotProps.node.data.subtotal" :value="slotProps.node.data.count"></progress></div>
                      </template>
                    </Tree>
                  </SplitterPanel>
                  <SplitterPanel :size="85">
                    <DataTable
                      ref="table"
                      showGridlines
                      scrollable
                      paginator
                      :lazy="true"
                      :totalRecords="total"
                      :first="first"
                      :rows="rows"
                      :rowsPerPageOptions="[100, 300, 500, 1000]"
                      :value="logs"
                      scrollHeight="100%"
                      :virtualScrollerOptions="{ itemSize: 49 }"
                      @page="pageChange"
                      style="padding: 10px;"
                    >
                      <Column
                        v-for="field in fields[0]"
                        :field="field.name"
                        :header="field.name"
                        :headerStyle="{'background-color': 'lightgray'}"
                      ></Column>
                      <template #empty> no data. </template>
                    </DataTable>
                  </SplitterPanel>
                </Splitter>
              </TabPanel>
              <TabPanel value="barchart">
                <div style="display: flex;">
                  <IftaLabel style="width: 50%;">
                    <Select style="width: 100%;" v-model="yaxis" inputId="yaxis" :options="Object.keys(axis)" @change="changeAxis" />
                    <label for="yaxis">Y-Axis</label>
                  </IftaLabel>
                  <IftaLabel style="width: 50%;">
                    <Select style="width: 100%;" v-model="xaxis" inputId="xaxis" :options="Object.keys(axis)" @change="changeAxis" />
                    <label for="xaxis">X-Axis</label>
                  </IftaLabel>
                </div>
                <div ref="barchart" style="height: calc(100% - 58px);"></div>
              </TabPanel>
            </TabPanels>
          </Tabs>
          <Dialog v-model:visible="showDialog" modal header="Config">
            <h3>Table</h3>
            <PickList v-model="fields" dataKey="name">
              <template v-slot:sourceheader>
                <label style="font-weight: bold;">Show</label>
              </template>
              <template v-slot:targetheader>
                <label style="font-weight: bold;">Hidden</label>
              </template>
              <template #option="{ option }">
                <label style="width: 100px;">{{ option.name }}</label>
              </template>
            </PickList>
            <h3>DrillDown</h3>
            <PickList v-model="drilldown" @update:modelValue="changeDrilldown">
              <template v-slot:sourceheader>
                <label style="font-weight: bold;">Enable</label>
              </template>
              <template v-slot:targetheader>
                <label style="font-weight: bold;">Disable</label>
              </template>
              <template #option="{ option }">
                <label style="width: 100px;">{{ option }}</label>
              </template>
            </PickList>
          </Dialog>
          <div v-if="blocked" style="position: fixed; top: 0px; left: 0px; width: 100%; height: 100%; z-index: 9999; background-color: rgba(0, 0, 0, 0.4);"></div>
        `,
        data: function() {
          return {
            http: axios.create(),
            blocked: false,
            date: null,
            // TODO: multiple
            query: '*:*',
            fields: [[
              {name: 'day'},
              {name: 'time'},
              {name: 'host'},
              {name: 'facility'},
              {name: 'severity'},
              {name: 'message'},
            ], [
              // {name: 'id'},
              {name: 'format'},
              {name: 'timestamp'},
              {name: 'addr'},
              {name: 'port'},
              {name: 'raw'},
            ]],
            logs: [],
            total: 0,
            first: 0,
            rows: 100,
            toast: useToast(),
            showDialog: false,
            socket: null,
            realtime: false,
            tab: 'table',
            barchart: null,
            yaxis: 'host',
            xaxis: 'severity',
            axis: {
              'day': {
                query: value => `day:["${value}" TO "${value}"]`,
                format: log => log.day,
                collect: data => [...new Set(data.map(row => row.day))].sort()
              },
              'time': {
                query: value => `time:["${value}:00:00" TO "${value}:59:59"]`,
                format: log => log.time.slice(0, 2),
                collect: data => [...Array(24)].map((_, i) => ('0' + i).slice(-2))
              },
              'host': {
                query: value => `host:"${value}"`,
                format: log => log.host,
                collect: data => [...new Set(data.map(row => row.host))].sort()
              },
              'format': {
                query: value => `format:"${value}"`,
                format: log => log.format,
                collect: data => ['unknown', 'rfc3164', 'rfc5424']
              },
              'addr': {
                query: value => `addr:"${value}"`,
                format: log => log.addr,
                collect: data => [...new Set(data.map(row => row.addr))].sort()
              },
              'port': {
                query: value => `port:${value}`,
                format: log => log.port,
                collect: data => [...new Set(data.map(row => row.port))].sort()
              },
              'facility': {
                query: value => `facility:"${value}"`,
                format: log => log.facility,
                collect: data => this.$data.config.facility
              },
              'severity': {
                query: value => `severity:"${value}"`,
                format: log => log.severity,
                collect: data => this.$data.config.severity
              },
            },
            drilldown: [[
              'severity',
              'host',
            ],[
              'day',
              'time',
              'format',
              'addr',
              'port',
              'facility',
            ]],
            facility: [],
            severity: [],
            host: [],
            config: {
              host: [],
              facility: [],
              severity: [],
            },
            tree: {
              value: [],
              selectedKeys: [],
              selected: null,
            }
          };
        },
        mounted: function() {
          var count = 0;
          var unblock = () => {
            return new Promise((resolve, reject) => {
              count--;
              if (count <= 0) {
                count = 0;
                this.$data.blocked = false;
              }
              this.$nextTick(() => resolve());
            });
          };

          this.$data.http.interceptors.request.use((config) => {
            return new Promise((resolve, reject) => {
              count++;
              this.$data.blocked = true;
              this.$nextTick(() => resolve(config));
            });
          }, (error) => {
            return unblock().then(() => Promise.reject(error));
          });

          this.$data.http.interceptors.response.use((response) => {
            return unblock().then(() => response);
          }, (error) => {
            return unblock().then(
              () => Promise.reject(error)
            ).then(() => {
              console.log(error);
              this.$data.toast.add({
                severity: 'error',
                summary: error,
              });
              return Promise.reject(error);
            });
          });

          this.$data.http.get(
            '/api/config'
          ).then(response => {
            this.$data.config.host     = response.data.host;
            this.$data.config.facility = response.data.facility;
            this.$data.config.severity = response.data.severity;
          }).then(
            () => this.search()
          ).catch(e => {
            this.$data.toast.add({
              severity: 'error',
              summary: e,
            });
          });
        },
        methods: {
          treeSelect: function(node) {
            this.$data.tree.selected = node;
            this.pageChange();
          },
          treeUnselect: function(node) {
            this.$data.tree.selected = null;
            this.pageChange();
          },
          treeExpand: function(node) {
            var axis = [...node.data.axis];
            var field = axis.shift();
            var query = encodeURIComponent(this.getQuery(node));
            this.$data.http.get(
              `/api/documents?query=${query}&fields=${field}`
            ).then(response => {
              var total = 0;
              var count = {};
              for (var row of response.data.docs) {
                var key = this.$data.axis[field].format(row);
                if (!(key in count)) count[key] = 0;
                count[key]++;
                total++;
              }
              node.children = Object.keys(count).map(key => {
                return {
                  key: crypto.randomUUID(),
                  label: key,
                  data: {
                    'key': field,
                    'value': key,
                    'subtotal': total,
                    'count': count[key],
                    'axis': axis
                  },
                  leaf: axis.length == 0,
                  parent: node
                };
              });
            });
          },
          clearFilter: function() {
            this.$data.day = null;
            this.$data.host = [];
            this.$data.facility = [];
            this.$data.severity = [];
            this.$data.query = '*:*';
            this.search();
          },
          dateSelect: function(event) {
            this.search();
          },
          getQuery: function(node, query) {
            query = `(${query || this.$data.query?.trim() || '*:*'})`;
            if (this.$data.date != null) {
              var y = this.$data.date.getFullYear();
              var m = ('0' + (this.$data.date.getMonth() + 1)).slice(-2);
              var d = ('0' + this.$data.date.getDate()).slice(-2);
              query = `${query} AND day:["${y}-${m}-${d}" TO "${y}-${m}-${d}"]`;
            }
            if (this.$data.host.length > 0) {
              query = `${query} AND host:${this.$data.host.join('|')}`;
            }
            if (this.$data.severity.length > 0) {
              query = `${query} AND severity:${this.$data.severity.join('|')}`;
            }
            if (this.$data.facility.length > 0) {
              query = `${query} AND facility:${this.$data.facility.join('|')}`;
            }
            if (node) {
              query = `${query} AND ${node.data.key}:${node.data.value}`;
              if (node.parent) {
                query = this.getQuery(node.parent, query);
              }
            }
            return query;
          },
          // TODO: 削除
          search: function(event) {
            this.$data.logs = [];
            this.$data.total = 0;
            this.$data.first = 0;
            return Promise.resolve().then(
              () => this.pageChange({first: 0, rows: this.$data.rows}, true)
            ).then(
              () => this.showChart()
            ).then(() => {
              this.$data.tree.value = [{
                key: crypto.randomUUID(),
                label: 'ALL',
                data: {
                  'key': '*',
                  'value': '*',
                  'subtotal': this.$data.total,
                  'count': this.$data.total,
                  'axis': [...this.$data.drilldown[0]]
                },
                leaf: false
              }];
            });
          },
          pageChange: function(event, showToast) {
            this.$data.rows = event?.rows || this.$data.rows;
            this.$data.first = event?.first || 0;
            return this.$data.http.get(
              `/api/documents?query=${encodeURIComponent(this.getQuery(this.$data.tree.selected))}`
              + `&first=${this.$data.first}`
              + `&last=${this.$data.first + this.$data.rows}`
            ).then(response => {
              this.$data.logs  = response.data.docs;
              this.$data.total = response.data.total;
              if (this.$data.total > 0) {
                if (showToast) {
                  this.$data.toast.add({
                    severity: 'info',
                    summary: `${this.$data.total.toLocaleString()} hits.(${response.data.ms.toLocaleString()}ms)`,
                    life: 5000,
                  });
                }
              } else {
                this.$data.toast.add({
                  severity: 'warn',
                  summary: `not found.`,
                  life: 5000,
                });
              }
            }).catch(e => {
              this.$data.toast.add({
                severity: 'error',
                summary: e,
              });
            });
          },
          download: function() {
            var a = document.createElement('a');
            a.target = '_blank';
            a.href = `/api/download/sqlite?query=${encodeURIComponent(this.getQuery())}`;
            a.click();
          },
          switchRealTimeMode() {
            this.$data.logs = [];
            this.$data.total = 0;
            this.$data.barchart?.clear();
            this.showChart();
            if (this.$data.realtime) {
              this.$data.socket = new WebSocket("/ws/realtime");
              this.$data.socket.addEventListener("message", event => {
                this.$data.logs = [JSON.parse(event.data)].concat(this.$data.logs);
                this.showChart();
              });
            } else {
              this.$data.socket.close();
              this.$data.socket = null;
              this.search();
            }
          },
          tabSwitch: function(tab) {
            this.$data.tab = tab;
            this.$data.barchart?.clear();
            this.showChart();
          },
          changeAxis: function() {
            this.$data.barchart?.clear();
            this.showChart();
          },
          changeDrilldown: function() {
            this.$data.tree.selected = null;
            this.$data.tree.selectedKeys = [];
            this.search();
          },
          showChart: function() {
            if (this.$data.tab == 'barchart') {
              var promise = (this.$data.realtime
                ? Promise.resolve({data: {docs: this.$data.logs}})
                : this.$data.http.get(`/api/documents?query=${encodeURIComponent(this.getQuery())}&fields=${this.$data.yaxis},${this.$data.xaxis}`)
              );
              return promise.then(response => {
                var barchart = this.$data.barchart || echarts.init(this.$refs.barchart);
                var yaxis = {
                  format: this.$data.axis[this.$data.yaxis].format,
                  list: (this.$data.axis[this.$data.yaxis].collect)(response.data.docs)
                };
                var xaxis = {
                  format: this.$data.axis[this.$data.xaxis].format,
                  list: (this.$data.axis[this.$data.xaxis].collect)(response.data.docs)
                };
                if (!this.$data.barchart) {
                  this.$data.barchart = barchart;
                  // TODO: clickで絞り込み
                  barchart.on('dblclick', (event) => {
                    if (!this.$data.realtime) {
                      this.$data.query = `(${this.$data.query?.trim() || '*:*'}) AND ${this.$data.axis[this.$data.yaxis].query(event.name)} AND ${this.$data.axis[this.$data.xaxis].query(event.seriesName)}`;
                      this.search();
                      this.$data.tab = 'table';
                    }
                  });
                }
                var count = {};
                for (var y of yaxis.list) {
                  count[y] = {};
                  for (var x of xaxis.list) {
                    count[y][x] = 0;
                  }
                }
                for (var log of response.data.docs) {
                  count[yaxis.format(log)][xaxis.format(log)]++;
                }
                var option = {
                  tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                      type: 'shadow'
                    }
                  },
                  legend: {},
                  xAxis: {
                    type: 'value'
                  },
                  yAxis: {
                    type: 'category',
                    data: yaxis.list
                  },
                  series: xaxis.list.map(x => {
                    return  {
                      name: x,
                      type: 'bar',
                      stack: 'total',
                      label: {
                        show: true
                      },
                      emphasis: {
                        focus: 'series'
                      },
                      data: yaxis.list.map(y => count[y][x])
                    };
                  })
                };
                barchart.setOption(option);
              }).catch(e => {
                this.$data.toast.add({
                  severity: 'error',
                  summary: e,
                });
              });
            } else {
              return Promise.resolve();
            }
          }
        }
      };

      const app = createApp(root);

      const month = [...Array(12)].map((_, i) => `${i + 1}月`);
      const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'];

      app.use(Config, {
        theme: {
          preset: Themes.Nora
        },
        locale: {
          dayNames: dayOfWeek,
          dayNamesShort: dayOfWeek,
          dayNamesMin: dayOfWeek,
          monthNames: month,
          monthNamesShort: month
        }
      }).use(
        ToastService
      ).directive(
        'tooltip', Tooltip
      );

      const components = [
        Button,
        Column,
        DataTable,
        DatePicker,
        Dialog,
        FloatLabel,
        InputText,
        IftaLabel,
        MultiSelect,
        PickList,
        Select,
        Splitter,
        SplitterPanel,
        Tab,
        Tabs,
        TabList,
        TabPanel,
        TabPanels,
        Toast,
        ToggleSwitch,
        Tree,
      ];
      for (var component of components) {
        app.component(component.name, component);
      }

      const proxy = app.mount('#app');
    </script>
  </body>
</html>
