<!DOCTYPE html>
<html lang="en">
  <head>
    <title>logucene</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <style>
      body {
        margin: 0;
      }
      #app {
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .p-tabs {
        height: calc(100% - 42px);
      }
      .p-tabpanels,.p-tabpanel-active {
        height: 100%;
      }
      .p-datatable,.p-datatable-table,.p-datatable-tbody {
        height: 100%;
      }
      .p-datatable-table-container {
        height: calc(100% - 58px - 1px);
      }
      .p-datatable-tbody > tr > td {
        white-space: nowrap;
      }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/primeicons@7.0.0/primeicons.min.css" rel="stylesheet">
  </head>
  <body>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/primevue/umd/primevue.min.js"></script>
    <script src="https://unpkg.com/@primevue/themes/umd/aura.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@6.0.0/dist/echarts.min.js"></script>

    <div id="app">
    </div>

    <script>
      const { createApp, ref, h } = Vue;
      const {
        Button,
        Column,
        Config,
        DataTable,
        DatePicker,
        Dialog,
        FloatLabel,
        InputText,
        IftaLabel,
        MultiSelect,
        PickList,
        Select,
        Tab,
        Tabs,
        TabList,
        TabPanel,
        TabPanels,
        Themes,
        Toast,
        ToastService,
        ToggleSwitch,
        useToast, 
      } = PrimeVue;

      const root = {
        template: `
          <Toast position="bottom-right" />
          <div style="display: flex; justify-content: space-between;">
            <div style="display: flex; align-items: center; width: 180px; justify-content: space-evenly;">
              <ToggleSwitch v-model="realtime" @change="switchRealTimeMode" />
              <label>RealTimeMode</label>
            </div>
            <div style="display: flex; width: calc(100% - 180px);">
              <DatePicker ref="datePicker" v-model="date" :disabled="realtime" dateFormat="yy-mm-dd" showIcon @update:modelValue="dateSelect" :inputStyle="{'width': '110px'}" />
              <MultiSelect v-model="host" :disabled="realtime" :options="hosts" style="width: 200px;" filter placeholder="host" :maxSelectedLabels="1" @update:modelValue="search" />
              <MultiSelect v-model="severity" :disabled="realtime" :options="['unknown','emerg','alert','crit','err','warning','notice','info','debug']" style="width: 200px;" filter placeholder="severity" :maxSelectedLabels="1" @update:modelValue="search" />
              <InputText type="text" v-model="query" :disabled="realtime" style="width: calc(100% - 731px);" placeholder="Query" @keydown="$event.key == 'Enter' && search()" />
              <Button severity="success" icon="pi pi-search" :disabled="realtime" @click="search" label="Search" />
              <Button severity="info" icon="pi pi-download" :disabled="realtime" @click="download" />
              <Button severity="help" icon="pi pi-cog" @click="showDialog = true" />
            </div>
          </div>
          <Tabs :value="tab" @update:value="tabSwitch">
            <TabList>
              <Tab value="table">Table</Tab>
              <Tab value="chart">Chart</Tab>
            </TabList>
            <TabPanels>
              <TabPanel value="table">
                <DataTable
                  ref="table"
                  showGridlines
                  scrollable
                  paginator
                  :lazy="true"
                  :totalRecords="total"
                  :first="first"
                  :rows="rows"
                  :rowsPerPageOptions="[100, 300, 500, 1000]"
                  :value="logs"
                  scrollHeight="100%"
                  :virtualScrollerOptions="{ itemSize: 49 }"
                  @page="pageChange"
                >
                  <Column
                    v-for="field in fields[0]"
                    :field="field.name"
                    :header="field.name"
                    :headerStyle="{'background-color': 'lightgray'}"
                  ></Column>
                  <template #empty> no data. </template>
                </DataTable>
              </TabPanel>
              <TabPanel value="chart">
                <div ref="chart" style="height: 100%;"></div>
              </TabPanel>
            </TabPanels>
          </Tabs>
          <Dialog v-model:visible="showDialog" modal header="Config">
            <h3>Table</h3>
            <PickList v-model="fields" dataKey="name">
              <template v-slot:sourceheader>
                <label style="font-weight: bold;">Show</label>
              </template>
              <template v-slot:targetheader>
                <label style="font-weight: bold;">Hidden</label>
              </template>
              <template #option="{ option  }">
                <label style="width: 100px;">{{ option.name }}</label>
              </template>
            </PickList>
            <h3>Chart</h3>
            <div style="display: flex;">
              <IftaLabel>
                <Select v-model="yaxis" inputId="yaxis" :options="Object.keys(axis)" @change="changeAxis" />
                <label for="yaxis">Y-Axis</label>
              </IftaLabel>
              <IftaLabel>
                <Select v-model="xaxis" inputId="xaxis" :options="Object.keys(axis)" @change="changeAxis" />
                <label for="xaxis">X-Axis</label>
              </IftaLabel>
            </div>
          </Dialog>
        `,
        data: function() {
          return {
            date: new Date(),
            query: '*:*',
            fields: [[
              {name: 'day'},
              {name: 'time'},
              {name: 'host'},
              {name: 'facility'},
              {name: 'severity'},
              {name: 'message'},
            ], [
              // {name: 'id'},
              {name: 'format'},
              {name: 'timestamp'},
              {name: 'addr'},
              {name: 'port'},
              {name: 'raw'},
            ]],
            logs: [],
            total: 0,
            first: 0,
            rows: 100,
            toast: useToast(),
            showDialog: false,
            socket: null,
            realtime: false,
            tab: 'table',
            chart: null,
            yaxis: 'host',
            xaxis: 'severity',
            axis: {
              'day': {query: value => `day:"${value}"`, format: log => log.day, collect: data => [...new Set(data.map(row => row.day))]},
              'time': {query: value => `time:["${value}:00:00" TO "${value}:59:59"]`, format: log => log.time.slice(0, 2), collect: data => [...Array(24)].map((_, i) => ('0' + i).slice(-2))},
              'host': {query: value => `host:"${value}"`, format: log => log.host, collect: data => [...new Set(data.map(row => row.host))]},
              'format': {query: value => `format:"${value}"`, format: log => log.format, collect: data => ['unknown', 'rfc3164', 'rfc5424']},
              'addr': {query: value => `addr:"${value}"`, format: log => log.addr, collect: data => [...new Set(data.map(row => row.addr))]},
              'port': {query: value => `port:${value}`, format: log => log.port, collect: data => [...new Set(data.map(row => row.port))]},
              'facility': {query: value => `facility:"${value}"`, format: log => log.facility, collect: data => [...new Set(data.map(row => row.facility))]},
              'severity': {query: value => `severity:"${value}"`, format: log => log.severity, collect: data => ['unknown', 'emerg', 'alert', 'crit', 'err', 'warning', 'notice', 'info', 'debug']},
            },
            severity: [],
            host: [],
            hosts: []
          };
        },
        mounted: function() {
          this.search();
          fetch('/api/hosts').then(response => response.json().then(json => this.$data.hosts = json));
        },
        methods: {
          dateSelect: function(event) {
            this.search();
          },
          getQuery: function() {
            var query = (this.$data.query || '').trim() == ''
              ? '*:*'
              : `${this.$data.query}`;
            if (this.$data.date != null) {
              var y = this.$data.date.getFullYear();
              var m = ('0' + (this.$data.date.getMonth() + 1)).slice(-2);
              var d = ('0' + this.$data.date.getDate()).slice(-2);
              query = `(${query}) AND day:[${y}-${m}-${d} TO ${y}-${m}-${d}]`;
            }
            if (this.$data.host.length > 0) {
              query = `(${query}) AND host:${this.$data.host.join('|')}`;
            }
            if (this.$data.severity.length > 0) {
              query = `(${query}) AND severity:${this.$data.severity.join('|')}`;
            }
            return encodeURIComponent(query);
          },
          search: function(event) {
            this.$data.logs = [];
            this.$data.total = 0;
            this.$data.first = 0;
            this.pageChange({first: 0, rows: this.$data.rows}, true);
            this.showChart();
          },
          pageChange: function(event, showToast) {
            this.$data.rows = event.rows;
            this.$data.first = event.first;
            fetch(
              `/api/documents?query=${this.getQuery()}`
              + `&first=${event.first}`
              + `&last=${event.first + event.rows}`
            ).then(response => {
              if (response.ok) {
                response.json().then(json => {
                  this.$data.logs = json.docs;
                  this.$data.total = json.total;
                  if (this.$data.total > 0) {
                    if (showToast) {
                      this.$data.toast.add({
                        severity: 'info',
                        summary: `${this.$data.total.toLocaleString()} hits.(${json.ms.toLocaleString()}ms)`,
                        life: 5000,
                      });
                    }
                  } else {
                    this.$data.toast.add({
                      severity: 'warn',
                      summary: `not found.`,
                      life: 5000,
                    });
                  }
                });
              } else {
                response.json().then(json => {
                  this.$data.toast.add({
                    severity: 'error',
                    summary: response.statusText,
                    detail: json.message,
                  });
                });
              }
            }).catch(e => {
              this.$data.toast.add({
                severity: 'error',
                summary: e,
              });
            });
          },
          download: function() {
            var a = document.createElement('a');
            a.target = '_blank';
            a.href = `/api/download/sqlite?query=${this.getQuery()}`;
            a.click();
          },
          switchRealTimeMode() {
            this.$data.logs = [];
            this.$data.total = 0;
            this.$data.chart?.clear();
            this.showChart();
            if (this.$data.realtime) {
              this.$data.socket = new WebSocket("/ws/realtime");
              this.$data.socket.addEventListener("message", event => {
                this.$data.logs = [JSON.parse(event.data)].concat(this.$data.logs);
                this.showChart();
              });
            } else {
              this.$data.socket.close();
              this.$data.socket = null;
              this.search();
            }
          },
          tabSwitch: function(tab) {
            this.$data.tab = tab;
            this.$data.chart?.clear();
            this.showChart();
          },
          changeAxis: function() {
            this.$data.chart?.clear();
            this.showChart();
          },
          showChart: function() {
            if (this.$data.tab == 'chart') {
              var promise = (this.$data.realtime
                ? Promise.resolve({
                  ok: true,
                  json: () => Promise.resolve({docs: this.$data.logs})
                })
                : fetch(
                  `/api/documents?query=${this.getQuery()}`
                )
              );
              promise.then(response => {
                if (response.ok) {
                  response.json().then(json => {
                    var chart = this.$data.chart || echarts.init(this.$refs.chart);
                    var yaxis = {
                      format: this.$data.axis[this.$data.yaxis].format,
                      list: (this.$data.axis[this.$data.yaxis].collect)(json.docs)
                    };
                    var xaxis = {
                      format: this.$data.axis[this.$data.xaxis].format,
                      list: (this.$data.axis[this.$data.xaxis].collect)(json.docs)
                    };
                    if (!this.$data.chart) {
                      this.$data.chart = chart;
                      chart.on('dblclick', (event) => {
                        this.$data.query = `(${this.$data.query}) AND ${this.$data.axis[this.$data.yaxis].query(event.name)} AND ${this.$data.axis[this.$data.xaxis].query(event.seriesName)}`;
                        this.search();
                        this.$data.tab = 'table';
                      });
                    }
                    var count = {};
                    for (var y of yaxis.list) {
                      count[y] = {};
                      for (var x of xaxis.list) {
                        count[y][x] = 0;
                      }
                    }
                    for (var log of json.docs) {
                      count[yaxis.format(log)][xaxis.format(log)]++;
                    }
                    option = {
                      tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                          type: 'shadow'
                        }
                      },
                      legend: {},
                      xAxis: {
                        type: 'value'
                      },
                      yAxis: {
                        type: 'category',
                        data: yaxis.list
                      },
                      series: xaxis.list.map(x => {
                        return  {
                          name: x,
                          type: 'bar',
                          stack: 'total',
                          label: {
                            show: true
                          },
                          emphasis: {
                            focus: 'series'
                          },
                          data: yaxis.list.map(y => count[y][x])
                        };
                      })
                    };
                    chart.setOption(option);
                  });
                } else {
                  response.json().then(json => {
                    this.$data.toast.add({
                      severity: 'error',
                      summary: response.statusText,
                      detail: json.message,
                    });
                  });
                }
              }).catch(e => {
                this.$data.toast.add({
                  severity: 'error',
                  summary: e,
                });
              });
            }
          }
        }
      };

      const app = createApp(root);

      const month = [...Array(12)].map((_, i) => `${i + 1}月`);
      const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'];

      app.use(Config, {
        theme: {
          preset: Themes.Aura
        },
        locale: {
          dayNames: dayOfWeek,
          dayNamesShort: dayOfWeek,
          dayNamesMin: dayOfWeek,
          monthNames: month,
          monthNamesShort: month
        }
      }).use(
        ToastService
      );

      const components = [
        Button,
        Column,
        DataTable,
        DatePicker,
        Dialog,
        FloatLabel,
        InputText,
        IftaLabel,
        MultiSelect,
        PickList,
        Select,
        Tab,
        Tabs,
        TabList,
        TabPanel,
        TabPanels,
        Toast,
        ToggleSwitch,
      ];
      for (var component of components) {
        app.component(component.name, component);
      }

      const proxy = app.mount('#app');
    </script>
  </body>
</html>
